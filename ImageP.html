<!DOCTYPE html>
<html>
    <style>
    </style>
    <body>
        <button id="analbutton" onclick="analyze()">Analyze</button>
        <input id="valuePicker" type="range" min="0" max="765">
        <select id="imagePicker" onchange="newImage()">
            <option value="thermal.jpg">1 Person</option>
            <option value="thermal2.jpg">2 People</option>
            <option value="thermal3.jpg">Greyscale</option>
            <option value="thermal4.jpg">Many People</option>
        </select>
        <br>
        <canvas id="ThermImg"></canvas> 
        
        <script>    
            var canvas = document.getElementById("ThermImg");
            var image = new Image();
            image.src = "thermal.jpg";
            var ctx;
            var imageData;
            var data;
            var importantIndexes;
            var R;
            var G;
            var B;
            
            var xMidSum = 0;
            var yMidSum = 0;
            var xSum = 0;
            var ySum = 0;
            
            var up = false;
            var right = false;
            var left = false;
            var down = false;

            var upCount = 0;
            var rightCount = 0;
            var leftCount = 0;
            var downCount = 0;
            
            var currentSize;
            var blobs = [];
            var filled = [];
            function blob(blobSize,Red,Green,Blue,xValue,yValue){
                this.blobSize = blobSize;
                this.Red = Red;
                this.Green = Green;
                this.Blue = Blue;
                this.xValue = xValue;
                this.yValue = yValue;
            }
            image.onload = function() {
                canvas.width = image.width;
                canvas.height = image.height;
                ctx = canvas.getContext("2d");
                ctx.drawImage(image, 0, 0);
                imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
                document.getElementById("valuePicker").value = 600;
            };
            function newImage(){
                image.src = imagePicker.value;
            }
            function analyze(){
                ctx.drawImage(image, 0, 0);
                imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
                data = imageData.data;
                importantIndexes = [];
                var thresh = document.getElementById("valuePicker").value;
                for (var i = 0; i < data.length; i += 4) {
                    var sum = data[i]+data[i + 1]+data[i + 2];
                    if(sum>thresh){
                        importantIndexes.push(i);
                    }
                }
                for(var i = 0; i<importantIndexes.length;i++){
                    var imageIndex = importantIndexes[i]
                    data[imageIndex] = 0;
                    data[imageIndex+1] = 255;
                    data[imageIndex+2] = 0;
                }
                var borderIndexes = [];
                for(var i = 0; i < data.length; i += 4){
                    if(data[i+1] == 255){
                        if(i>canvas.width*4&&i<data.length-4-canvas.width*4){
                            if(data[i+canvas.width*4+1]!=255 || data[i+4+1]!=255 || data[i-4+1]!=255 || data[i-canvas.width*4+1]!=255){
                                borderIndexes.push(i);
                            }
                            else{
                                
                            }
                        }
                    }
                }
                ctx.drawImage(image, 0, 0);
                imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
                data = imageData.data;
                
                for(var i = 0; i<importantIndexes.length;i++){
                    var borderIndex = borderIndexes[i]

                    data[borderIndex-4] = 0;
                    data[borderIndex+1-4] = 0;
                    data[borderIndex+2-4] = 0;

                    data[borderIndex] = 0;
                    data[borderIndex+1] = 0;
                    data[borderIndex+2] = 0;


                    data[borderIndex+4] = 0;
                    data[borderIndex+1+4] = 0;
                    data[borderIndex+2+4] = 0;
                }
                blobs = []; 
                filled = [];
                for(var i = 0; i<importantIndexes.length;i++){
                    if((data[importantIndexes[i]]==0&&data[importantIndexes[i]+1]==0&&data[importantIndexes[i]+2]==0)||
                        (filled.indexOf(importantIndexes[i])>=0)){
                    }
                    else{
                        currentSize = 0;
                        R = Math.round(Math.random()*255);
                        G = Math.round(Math.random()*255);  
                        B = Math.round(Math.random()*255);
                        up = false;
                        right = false;
                        left = false;
                        down = false;
                        upCount = 0;
                        rightCount = 0;
                        leftCount = 0;
                        downCount = 0;
                        xMidSum = 0;
                        yMidSum = 0;
                        xSum = 0;
                        ySum = 0;
                        fillImg(importantIndexes[i]);
                        var xMid = xMidSum/(xSum);
                        var yMid = yMidSum/(ySum);
                        var yVals = Math.floor(importantIndexes[i]/(canvas.width*4));
                        var xValsTemp = importantIndexes[i]%(canvas.width*4);
                        var xVals = Math.floor(xValsTemp/4);
                        if(currentSize > 100){
                            blobs.push(new blob(currentSize,R,G,B,xVals+xMid,yVals+yMid));
                        }
                    }
                }
                ctx.putImageData(imageData, 0, 0);
                for(var i = 0;i<blobs.length;i++){
                    ctx.fillStyle = "rgb("+blobs[i].Red+","+blobs[i].Green+","+blobs[i].Blue+")";
                    ctx.fillText("Blob:" + blobs[i].blobSize,10,i*10+10,canvas.width);
                    ctx.beginPath();
                    ctx.arc(blobs[i].xValue, blobs[i].yValue, 6, 0, 2 * Math.PI, false);
                    ctx.closePath();
                    ctx.fillStyle = 'red';
                    ctx.fill();
                }
                
            }

            function fillImg(currentIndex){
                if((data[currentIndex]==0&&
                   data[currentIndex+1]==0&&data[currentIndex+2]==0)||(filled.indexOf(currentIndex)>=0)){
                    return;
                }
                else{
                    if(up){
                        ySum++
                        upCount++;
                        downCount--;
                        yMidSum-=upCount;
                    }
                    else if(right){
                        xSum++
                        rightCount++;
                        leftCount--;
                        xMidSum+=rightCount;
                    }
                    else if(left){
                        xSum++
                        leftCount++;
                        rightCount--;
                        xMidSum-=leftCount;
                    }
                    else if(down){
                        ySum++
                        downCount++;
                        upCount--;
                        yMidSum+=downCount;
                    }
                    filled.push(currentIndex);
                    currentSize++;
                    data[currentIndex] = R;
                    data[currentIndex+1] = G;
                    data[currentIndex+2] = B;
                    
                    up = true;
                    right = false;
                    left = false;
                    down = false;
                    fillImg(currentIndex-canvas.width*4);
                    
                    up = false;
                    right = true;
                    left = false;
                    down = false;
                    fillImg(currentIndex+4);
                    
                    up = false;
                    right = false;
                    left = true;
                    down = false;
                    fillImg(currentIndex-4);
                    
                    up = false;
                    right = false;
                    left = false;
                    down = true;
                    fillImg(currentIndex+canvas.width*4);
                    
                    up = false;
                    right = false;
                    left = false;
                    down = false;
                }
            }
        </script>
    </body>
</html>